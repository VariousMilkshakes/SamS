var common = require('../common');
var orchestrate = require('orchestrate');

var USAGE = "orcli use [key] (alias)";

module.exports = function (args, opts) {
  var key = args[0];
  var alias = args[1];

  if (!key) throw new Error(USAGE);

  var config = common.get_config();
  var raw_api_key = config.keys[key] || key;
  var db = common.get_db(raw_api_key);

  // test to see if key is valid before writing
  return db.ping()
  .then(function () {
    // key is valid, so write it to current
    config.current = raw_api_key;
    if (opts) config[alias] = raw_api_key;
    common.put_config(config);
    return 'now using ' + (alias || 'unnamed') + ' key';
  })
  .fail(function (res) {
    if (res.statusCode === 401)
      throw new Error('401: invalid API key');
    else
      throw new Error(res.statusCode);
  });
};
