var patch = require('../../lib-cov/commands/patch');
var nock = require('nock');
var OIO_URL = 'https://api.orchestrate.io';
var assert = require('assert');

describe('patch', function () {
  afterEach(function () {
    nock.cleanAll();
  });

  it('should do single update', function (done) {
    var scope = nock(OIO_URL)
    .patch('/v0/users/garbados')
    .reply(201);

    patch(['users', 'garbados', 'replace', 'is_a_babe', true], {})
    .then(function () {
      assert(scope.isDone());
      done();
    })
    .fail(done);
  });

  it('should do multiple updates', function (done) {
    var scope = nock(OIO_URL)
    .patch('/v0/users/garbados')
    .reply(201);

    patch(['users', 'garbados'], [
      { "op": "add", "path": "birth_place.city", "value": "New York" },
      { "op": "remove", "path": "birth_place.country" },
      { "op": "replace", "path": "birth_place.state", "value": "New York" },
      { "op": "move", "from": "first_name", "path": "deprecated.first_name" },
      { "op": "copy", "from": "full_name", "path": "name" },
      { "op": "test", "path": "age", "value": 28 },
      // TODO: `inc` is not supported by orchestrate.js as of Jan 9, 2015
      // { "op": "inc", "path": "age", "value": 1 },
      // { "op": "inc", "path": "years_until_death", "value": -1 }
    ])
    .then(function () {
      assert(scope.isDone());
      done();
    })
    .fail(done);
  });
});
