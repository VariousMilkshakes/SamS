#!/usr/bin/env node

var stdin = require('../lib/stdin');
var reader = require('../lib/reader');
var commands = require('../lib/commands');
var yargs = require('yargs')
            .alias('h', 'head')
            .describe('h', 'Print response headers rather than response body.')
            .alias('v', 'verbose')
            .describe('v', 'Print response headers and body.')
            .alias('s', 'silent')
            .describe('s', 'Print nothing unless an error occurs.')
            .usage('Use Orchestrate from your terminal.\norcli [action]')
            .example('orcli use YOUR_API_KEY', 'Authenticate with the given key')
            .example('orcli get users garbados', 'Get the item in collection `users` and with key `garbados`')
            .example('orcli search users "name:Dian*"', 'Find every user whose name starts with \'Dian\'')
            .example('orcli graph users garbados likes create food sushi', 'Add a \'likes\' relationship between garbados and sushi.')
            .example('orcli merge users garbados --is_a_babe=true', 'Update garbados with the field `is_a_babe` set to `true`');
var argv =  yargs.argv;

if (argv.help) {
  console.log(yargs.help());
  console.log('Actions:');
  Object.keys(commands.commands).forEach(function (command) {
    console.log('  ', command);
  });
  return;
}

stdin.get(process.stdin)
.then(function (input) {
  if (input) 
    return JSON.parse(input);
  else 
    return null;
})
.then(function (input) {
  var opts = reader(argv);
  if (input) opts.cmd = input;

  return {
    cmd: commands.call({
      api_key: opts.opt['api-key']
    }, opts.arg, opts.cmd),
    print: opts.opt
  };
})
.then(function (opts) {
  return opts.cmd.then(function (body, head) {
    var print_head = (typeof(head) === 'string') ? head : JSON.stringify(head);
    var print_body = (typeof(body) === 'string') ? body : JSON.stringify(body);
    if (head && opts.print.head || opts.print.verbose)
      console.log(print_head);
    if (body && opts.print.verbose)
      console.log(print_body);
    if (body && !opts.print.verbose && !opts.print.head)
      console.log(print_body);
    process.exit(0);
  })
  .fail(function (err) {
    console.error(err.body || err);
    process.exit(1);
  });
});
